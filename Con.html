<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wexford Staff Connect</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Styles & Animation for Polish */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0B8F4A; /* Wexford Green */
            --primary-dark: #076d38;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f4068 0%, #162447 100%);
            min-height: 100vh;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
        }
        .message-bubble {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
            word-wrap: break-word;
            max-width: 100%;
        }
        .message.own .message-bubble {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(11, 143, 74, 0.3);
        }
        .message:not(.own) .message-bubble {
            background: white;
            color: #1f2937;
        }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f5f9; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body class="antialiased">
    <div class="bg-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Global Message Box (used for errors/confirmation) -->
    <div id="message-box" class="fixed top-4 right-4 z-[10000] p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 transform translate-x-full" style="display: none;"></div>

    <!-- CONNECTION STATUS / PASSWORD MODAL -->
    <div id="status-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 backdrop-blur-md z-[9999] flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-11/12 shadow-2xl text-center transition-all duration-500 transform scale-100">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-3">Staff Connection Gateway</h2>
            
            <div id="status-dashboard" class="space-y-4 text-left">
                <!-- Status checks injected here -->
            </div>

            <div class="mt-8 pt-4 border-t">
                <p class="text-gray-600 mb-4 font-semibold">üîë Enter Staff Access Code</p>
                <input type="password" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10" autocomplete="off" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-2xl font-semibold tracking-widest focus:ring-4 focus:ring-green-100 focus:border-primary-dark">
                <div id="password-error" class="text-red-500 font-medium mt-3 hidden">‚ùå Incorrect code. Try again.</div>
                <button onclick="verifyPassword()" id="access-button" class="mt-6 w-full py-4 text-lg font-bold text-white rounded-xl transition duration-300 bg-gradient-to-r from-primary to-green-600 hover:from-green-600 hover:to-primary shadow-lg shadow-green-500/50">
                    <i class="fas fa-sign-in-alt mr-2"></i> Access Channel
                </button>
            </div>
        </div>
    </div>

    <!-- Login Form (One-time registration) -->
    <div id="login-container" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm z-[9998] flex items-center justify-center hidden">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-11/12 shadow-2xl transition-all duration-500 transform scale-100">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-extrabold text-gray-800">Complete Your Staff Profile</h2>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="mb-4 md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-1">üë§ Full Name</label>
                        <input type="text" id="staff-name" required class="w-full p-3 border border-gray-300 rounded-xl">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">üíº Department</label>
                        <select id="staff-department" required class="w-full p-3 border border-gray-300 rounded-xl">
                            <option value="">Select Department...</option>
                            <option value="Administration">Administration</option>
                            <option value="Lower Primary">Lower Primary</option>
                            <option value="Upper Primary">Upper Primary</option>
                            <option value="JHS">JHS</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">üìû Staff ID / Phone</label>
                        <input type="text" id="staff-id" required class="w-full p-3 border border-gray-300 rounded-xl">
                    </div>
                </div>
                
                <button type="submit" class="mt-4 w-full py-3.5 text-lg font-bold text-white rounded-xl transition duration-300 bg-gradient-to-r from-primary to-green-600 hover:from-green-600 hover:to-primary shadow-md shadow-green-500/30">
                    <i class="fas fa-check-circle mr-2"></i> Register & Enter Chat
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chat-container" class="max-w-4xl mx-auto h-screen relative flex flex-col bg-white shadow-2xl rounded-xl md:my-6 md:h-[calc(100vh-3rem)] overflow-hidden hidden">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 flex items-center justify-center hidden">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
            <span class="ml-4 text-xl font-semibold text-gray-600">Initializing...</span>
        </div>

        <!-- Chat Header -->
        <div class="flex items-center justify-between p-4 md:p-5 bg-primary text-white shadow-lg flex-wrap gap-2">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-white text-primary rounded-lg text-xl font-bold flex items-center justify-center mr-3">WEX</div>
                <div>
                    <h1 class="text-xl font-extrabold">Staff Connect üí¨</h1>
                    <p class="text-xs opacity-80">Wexford Private Channel - Resilient</p>
                </div>
            </div>
            <div class="flex items-center gap-3 text-sm">
                <span id="user-display" class="bg-white bg-opacity-20 py-1.5 px-3 rounded-full font-semibold truncate max-w-[200px]"></span>
                <button onclick="logout()" class="bg-white bg-opacity-20 py-1.5 px-3 rounded-full hover:bg-opacity-30 transition duration-200">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="chat-messages flex-grow overflow-y-auto p-4 md:p-6 bg-gray-50 space-y-4">
            <div id="empty-state" class="text-center pt-16 text-gray-400">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600">Start the Conversation</h3>
                <p>Chat history is preserved for the last 14 days.</p>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 md:p-5 bg-white border-t border-gray-100 shadow-t-xl">
            <div class="flex gap-3 items-end">
                <textarea id="chat-input" placeholder="Type your message... (Shift + Enter for new line)" rows="1" class="flex-grow p-3 border border-gray-300 rounded-2xl resize-none focus:ring-2 focus:ring-primary focus:border-primary transition duration-200" onkeypress="handleEnter(event)"></textarea>
                <button onclick="sendMessage()" id="send-button" class="w-12 h-12 flex items-center justify-center bg-primary text-white rounded-full transition duration-300 hover:scale-105 hover:bg-green-600 shadow-lg shadow-green-500/40">
                    <i class="fas fa-paper-plane text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIGURATION ---
        const CORRECT_PASSWORD = 'STAFF';
        const APP_ID_FALLBACK = 'default-app-id';

        const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FALLBACK;
        
        let firebaseConfig = {};
        let configError = null;

        // Attempt to load and validate environment config
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const parsedConfig = JSON.parse(configString);
            
            if (parsedConfig && parsedConfig.projectId && parsedConfig.apiKey) {
                firebaseConfig = parsedConfig;
                console.log("Configuration Check: Environment configuration loaded successfully.");
            } else {
                // --- FALLBACK CONFIGURATION (If Environment Config is Missing) ---
                configError = "Missing projectId or apiKey in environment configuration. Using fallback.";
                console.warn(configError);
                firebaseConfig = {
                    apiKey: "AIzaSy_FAKE_API_KEY_FOR_TESTING_12345", 
                    authDomain: `${APP_ID_FALLBACK}.firebaseapp.com`,
                    projectId: APP_ID_FALLBACK,
                    storageBucket: `${APP_ID_FALLBACK}.appspot.com`,
                    messagingSenderId: "123456789012",
                    appId: `1:123456789012:web:abcdef1234567890`
                };
            }
        } catch (e) {
            configError = "Failed to parse Firebase configuration string. Using fallback.";
            console.error(configError, e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentStaff = null;
        let unsubscribeMessages = null;
        
        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const loginContainer = document.getElementById('login-container');
        const statusModal = document.getElementById('status-modal');
        const statusDashboard = document.getElementById('status-dashboard');
        const userDisplay = document.getElementById('user-display');
        const chatMessagesEl = document.getElementById('chat-messages');
        const loadingOverlay = document.getElementById('loading-overlay');
        const chatInput = document.getElementById('chat-input');
        const messageBox = document.getElementById('message-box');
        
        // Enable Firebase debugging logs for troubleshooting
        setLogLevel('debug');

        // --- STATUS DASHBOARD RENDER ---
        function renderStatusDashboard() {
            let configReady = configError === null;

            const dashItems = [
                {
                    label: "Firebase Project ID",
                    value: firebaseConfig.projectId,
                    status: configReady ? 'OK' : 'FALLBACK'
                },
                {
                    label: "API Key Status",
                    value: configReady ? 'Present' : 'FALLBACK (Test Key)',
                    status: configReady ? 'OK' : 'FALLBACK'
                },
                {
                    label: "Auth Token Supplied",
                    value: initialAuthToken ? 'Present (Custom)' : 'Missing (Anon Sign-in)',
                    status: initialAuthToken ? 'OK' : 'ANON'
                },
                {
                    label: "Configuration Method",
                    value: configReady ? 'Environment' : 'Internal Fallback',
                    status: configReady ? 'OK' : 'FALLBACK'
                }
            ];
            
            statusDashboard.innerHTML = '';

            dashItems.forEach(item => {
                const isOk = item.status === 'OK';
                const isFallback = item.status === 'FALLBACK';
                
                const statusIcon = isOk ? '<i class="fas fa-check-circle text-green-500"></i>' : (isFallback ? '<i class="fas fa-cogs text-yellow-500"></i>' : '<i class="fas fa-user-lock text-indigo-500"></i>');
                const valueClass = isOk ? 'text-gray-800' : (isFallback ? 'text-yellow-700 font-bold' : 'text-indigo-700');

                statusDashboard.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                        <span class="text-sm text-gray-600 font-medium">${item.label}</span>
                        <div class="flex items-center gap-2">
                            ${statusIcon}
                            <span class="text-sm ${valueClass}">${item.value}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        // --- UTILITY FUNCTIONS ---
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `fixed top-4 right-4 z-[10000] p-4 rounded-lg shadow-xl font-medium transition-all duration-300 transform ${isError ? 'bg-red-600' : 'bg-green-600'} translate-x-0`;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
                messageBox.classList.remove('translate-x-0');
            }, 5000);
            setTimeout(() => {
                 messageBox.style.display = 'none';
            }, 5300);
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function getProfilePath(uid) {
            return `artifacts/${appId}/users/${uid}/profile/details`;
        }
        
        function getMessagesCollectionPath() {
            // Public collection for chat
            return `artifacts/${appId}/public/data/messages`;
        }

        function formatTimestamp(timestamp) {
             if (!timestamp) return 'N/A';
            const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
            return `${time} (${dateStr})`;
        }
        
        function getFormattedDate(timestamp) {
            const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const messageDate = new Date(date);
            messageDate.setHours(0, 0, 0, 0);
            
            const diffDays = Math.round((today.getTime() - messageDate.getTime()) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }


        // --- PASSWORD VERIFICATION ---
        window.verifyPassword = function() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('password-error');
            
            if (input.value.toUpperCase() === CORRECT_PASSWORD) {
                sessionStorage.setItem('staffAuthenticated', 'true');
                statusModal.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => { statusModal.style.display = 'none'; }, 500);
                
                initializeAppAndAuth();
            } else {
                error.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.value = '';
                
                setTimeout(() => { input.classList.remove('border-red-500'); }, 500);
                setTimeout(() => { error.classList.add('hidden'); }, 3000);
            }
        }

        // --- AUTHENTICATION & INITIALIZATION ---
        async function initializeAppAndAuth() {
            if (sessionStorage.getItem('staffAuthenticated') !== 'true') {
                return;
            }

            try {
                showLoading(true);

                // --- 1. INITIALIZE APP ---
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                // --- 2. SIGN IN ---
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // CRUCIAL FALLBACK: Use anonymous sign-in if no custom token is available
                    await signInAnonymously(auth);
                }

                // --- 3. AUTH LISTENER ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        checkStaffProfile(user.uid);
                    } else {
                        console.log("Auth State Changed: User signed out.");
                        showLoading(false);
                    }
                });
            } catch (error) {
                // *** CRITICAL FAILURE LOGGING ***
                console.error("--- CRITICAL FIREBASE INIT/AUTH FAILURE ---");
                console.error("Specific Error Code:", error.code);
                console.error("Specific Error Message:", error.message);
                
                showMessage(`Authentication failed (${error.code || 'UNKNOWN'}). Using fallback auth.`, true);
                showLoading(false);
                sessionStorage.removeItem('staffAuthenticated');
                statusModal.style.display = 'flex';
                renderStatusDashboard();
            }
        }

        // --- PROFILE MANAGEMENT (ONE-TIME LOGIN) ---
        async function checkStaffProfile(uid) {
            const profileRef = doc(db, getProfilePath(uid));
            try {
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    currentStaff = profileSnap.data();
                    currentStaff.uid = uid;
                    await setDoc(profileRef, { lastLogin: serverTimestamp() }, { merge: true });
                    startChatSession();
                } else {
                    showLoading(false);
                    loginContainer.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching staff profile:", error);
                showMessage("Failed to load user profile. Check your browser permissions.", true);
                showLoading(false);
            }
        }

        window.handleLogin = async function(event) {
            event.preventDefault();
            
            if (!auth || !auth.currentUser) {
                showMessage("Error: Authentication not ready. Please refresh.", true);
                return;
            }

            const uid = auth.currentUser.uid;
            const name = document.getElementById('staff-name').value.trim();
            const department = document.getElementById('staff-department').value;
            const staffId = document.getElementById('staff-id').value.trim();
            
            if (!name || !department || !staffId) return;

            currentStaff = {
                uid: uid,
                name: name,
                department: department,
                staffId: staffId,
                joinedAt: Date.now(),
                lastLogin: Date.now()
            };
            
            const profileRef = doc(db, getProfilePath(uid));
            showLoading(true);

            try {
                await setDoc(profileRef, currentStaff);
                showMessage(`Welcome, ${name}! Your profile is saved.`);
                startChatSession();
            } catch (error) {
                console.error("Error creating staff profile:", error);
                showMessage("Failed to save staff details. Security rules may be preventing write access.", true);
                showLoading(false);
            }
        }

        // --- CHAT SESSION START ---
        function startChatSession() {
            showLoading(false);
            loginContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            
            const staffIdShort = currentStaff.uid.substring(0, 6);
            userDisplay.innerHTML = `${currentStaff.name} <span class="text-xs opacity-70 ml-1">#${staffIdShort}</span>`;
            
            loadMessages();
        }
        
        // --- CHAT MESSAGES LOGIC ---
        function loadMessages() {
            if (!db || !currentStaff || !currentStaff.uid) return;
            
            if (unsubscribeMessages) {
                unsubscribeMessages(); 
            }

            const twoWeeksAgo = Date.now() - (14 * 24 * 60 * 60 * 1000);
            const messagesRef = collection(db, getMessagesCollectionPath());
            
            const q = query(
                messagesRef,
                where('timestamp', '>=', twoWeeksAgo),
                orderBy('timestamp', 'asc')
            );

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                showMessage("Real-time connection lost. Refresh the page.", true);
            }
            );
        }

        function renderMessages(messages) {
            const shouldScroll = chatMessagesEl.scrollHeight - chatMessagesEl.scrollTop < chatMessagesEl.clientHeight + 100;
            
            chatMessagesEl.innerHTML = '';
            
            const emptyStateEl = document.getElementById('empty-state');
            emptyStateEl.style.display = messages.length === 0 ? 'block' : 'none';
            
            let lastDate = null;

            messages.forEach(msg => {
                const currentDateKey = getFormattedDate(msg.timestamp);
                if (currentDateKey !== lastDate) {
                    const divider = document.createElement('div');
                    divider.className = 'text-center my-6 relative';
                    divider.innerHTML = `<span class="bg-gray-50 px-3 py-1 text-xs font-medium text-gray-500 rounded-full border border-gray-200 z-10 relative">${currentDateKey}</span>`;
                    chatMessagesEl.appendChild(divider);
                    lastDate = currentDateKey;
                }
                
                const isOwn = msg.uid === currentStaff.uid;
                const messageEl = createMessageElement(msg, isOwn);
                chatMessagesEl.appendChild(messageEl);
            });
            
            if (shouldScroll) {
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }
        }

        function createMessageElement(msg, isOwn) {
            const div = document.createElement('div');
            div.className = `message flex gap-3 mb-4 ${isOwn ? 'own flex-row-reverse' : 'flex-row'}`;
            
            const initial = msg.name.charAt(0).toUpperCase();
            const avatarBg = isOwn ? 'bg-primary' : 'bg-indigo-600';
            const bubbleRounded = isOwn ? 'rounded-tl-xl rounded-b-xl' : 'rounded-tr-xl rounded-b-xl';
            const nameAlignment = isOwn ? 'justify-end' : 'justify-start';

            div.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg ${avatarBg} flex-shrink-0 shadow-md">${initial}</div>
                <div class="max-w-xs md:max-w-md">
                    <div class="flex items-center gap-2 mb-1 text-xs text-gray-500 ${nameAlignment}">
                        <span class="font-semibold text-gray-800">${msg.name}</span>
                        <span class="text-primary font-medium bg-green-50 px-2 py-0.5 rounded-full text-xs">${msg.department}</span>
                        <span class="text-xs text-gray-400">${formatTimestamp(msg.timestamp)}</span>
                    </div>
                    <div class="message-bubble p-3 ${bubbleRounded} rounded-tr-xl rounded-bl-xl shadow-md">
                        ${msg.text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            return div;
        }

        window.sendMessage = async function() {
            if (!currentStaff) {
                showMessage("Please login before sending messages.", true);
                return;
            }

            const text = chatInput.value.trim();
            if (!text) return;
            
            const message = {
                uid: currentStaff.uid,
                name: currentStaff.name,
                department: currentStaff.department,
                text: text,
                // Use Date.now() for accurate client-side time when saving.
                timestamp: Date.now() 
            };
            
            chatInput.value = '';
            chatInput.style.height = '48px'; 
            
            try {
                const messagesRef = collection(db, getMessagesCollectionPath());
                await addDoc(messagesRef, message);
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage("Failed to send message. Connection error or security rule violation.", true);
            }
        }

        window.handleEnter = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        chatInput.addEventListener('input', function() {
            this.style.height = '48px'; 
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // --- LOGOUT ---
        window.logout = async function() {
            if (!window.confirm('Are you sure you want to log out?')) return; 

            showLoading(true);
            if (unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages = null; }
            if (auth) { await signOut(auth).catch(e => console.error("Sign out error:", e)); }

            currentStaff = null;
            sessionStorage.removeItem('staffAuthenticated');
            chatMessagesEl.innerHTML = '';
            
            showLoading(false);
            chatContainer.classList.add('hidden');
            loginContainer.classList.add('hidden');
            
            statusModal.style.display = 'flex';
            statusModal.classList.remove('opacity-0', 'pointer-events-none');
            renderStatusDashboard();
        }

        // --- INITIALIZE ON LOAD ---
        window.onload = () => {
             renderStatusDashboard();

             if (sessionStorage.getItem('staffAuthenticated') === 'true') {
                statusModal.style.display = 'none';
                initializeAppAndAuth();
            } else {
                statusModal.style.display = 'flex';
                document.getElementById('password-input').focus();
            }
        };

    </script>
</body>
</html>
