<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wexford Staff Connect</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Styles & Animation for Polish */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0B8F4A; /* Wexford Green */
            --primary-dark: #076d38;
            --secondary-bg: #E8F5EE;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f4068 0%, #162447 100%);
            min-height: 100vh;
        }

        /* Animated Background Particles (Simplified) */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
        }

        .particle:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 30%; animation-delay: 2s; }
        .particle:nth-child(3) { width: 100px; height: 100px; left: 50%; animation-delay: 4s; }
        .particle:nth-child(4) { width: 70px; height: 70px; left: 70%; animation-delay: 6s; }
        .particle:nth-child(5) { width: 90px; height: 90px; left: 90%; animation-delay: 8s; }

        @keyframes float {
            0%, 100% { transform: translateY(100vh); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* Message Bubble Custom Styles */
        .message-bubble {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(11, 143, 74, 0.3);
        }

        .message:not(.own) .message-bubble {
            background: white;
            color: #1f2937;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
    </style>
</head>
<body class="antialiased">
    <div class="bg-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Global Message Box (used for errors/confirmation) -->
    <div id="message-box" class="fixed top-4 right-4 z-[10000] p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 transform translate-x-full" style="display: none;"></div>


    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 backdrop-blur-md z-[9999] flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-11/12 shadow-2xl text-center transition-all duration-500 transform scale-100" id="password-content">
            <div class="text-6xl mb-4 text-indigo-600 animate-pulse"><i class="fas fa-lock"></i></div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Staff Access</h2>
            <p class="text-gray-500 mb-6">Enter the access code to authenticate.</p>
            <input type="password" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10" autocomplete="off" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-2xl font-semibold tracking-widest transition duration-300 focus:ring-4 focus:ring-green-100 focus:border-primary-dark">
            <div id="password-error" class="text-red-500 font-medium mt-3 hidden">‚ùå Incorrect code. Try again.</div>
            <button onclick="verifyPassword()" class="mt-6 w-full py-4 text-lg font-bold text-white rounded-xl transition duration-300 bg-gradient-to-r from-primary to-green-600 hover:from-green-600 hover:to-primary shadow-lg shadow-green-500/50">
                <i class="fas fa-sign-in-alt mr-2"></i> Enter Channel
            </button>
            <div class="mt-6 p-3 bg-yellow-50 text-yellow-800 rounded-xl text-sm border border-yellow-200">
                <strong>Private Channel:</strong> This is a secure communication area.
            </div>
        </div>
    </div>

    <!-- Login Form (One-time registration) -->
    <div id="login-container" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm z-[9998] flex items-center justify-center hidden">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-11/12 shadow-2xl transition-all duration-500 transform scale-100">
            <div class="text-center mb-6">
                <div class="mx-auto w-16 h-16 bg-primary rounded-xl text-3xl text-white flex items-center justify-center mb-3">WEX</div>
                <h2 class="text-2xl font-extrabold text-gray-800">Complete Your Staff Profile</h2>
                <p class="text-gray-500 mt-1">This is a **one-time** registration for persistent login.</p>
            </div>

            <form onsubmit="handleLogin(event)">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="mb-4 md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-1">üë§ Full Name</label>
                        <input type="text" id="staff-name" placeholder="E.g., Dr. Jane Doe" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">üíº Department</label>
                        <select id="staff-department" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                            <option value="">Select Department...</option>
                            <option value="Administration">Administration</option>
                            <option value="Lower Primary">Lower Primary</option>
                            <option value="Upper Primary">Upper Primary</option>
                            <option value="JHS">JHS</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="English">English</option>
                            <option value="Science">Science</option>
                            <option value="ICT">ICT</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">üìû Staff ID / Phone</label>
                        <input type="text" id="staff-id" placeholder="Staff ID or Contact" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                    </div>
                </div>
                
                <button type="submit" class="mt-4 w-full py-3.5 text-lg font-bold text-white rounded-xl transition duration-300 bg-gradient-to-r from-primary to-green-600 hover:from-green-600 hover:to-primary shadow-md shadow-green-500/30">
                    <i class="fas fa-check-circle mr-2"></i> Register & Enter Chat
                </button>
            </form>
        </div>
    </div>


    <!-- Chat Container -->
    <div id="chat-container" class="max-w-4xl mx-auto h-screen relative flex flex-col bg-white shadow-2xl rounded-xl md:my-6 md:h-[calc(100vh-3rem)] overflow-hidden hidden">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 flex items-center justify-center hidden">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
            <span class="ml-4 text-xl font-semibold text-gray-600">Initializing...</span>
        </div>

        <!-- Chat Header -->
        <div class="flex items-center justify-between p-4 md:p-5 bg-primary text-white shadow-lg flex-wrap gap-2">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-white text-primary rounded-lg text-xl font-bold flex items-center justify-center mr-3">WEX</div>
                <div>
                    <h1 class="text-xl font-extrabold">Staff Connect üí¨</h1>
                    <p class="text-xs opacity-80">Wexford Private Channel - No Lapses</p>
                </div>
            </div>
            <div class="flex items-center gap-3 text-sm">
                <span id="user-display" class="bg-white bg-opacity-20 py-1.5 px-3 rounded-full font-semibold truncate max-w-[200px]"></span>
                <button onclick="logout()" class="bg-white bg-opacity-20 py-1.5 px-3 rounded-full hover:bg-opacity-30 transition duration-200">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="chat-messages flex-grow overflow-y-auto p-4 md:p-6 bg-gray-50 space-y-4">
            <!-- Messages are injected here -->
            <div id="empty-state" class="text-center pt-16 text-gray-400">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600">Start the Conversation</h3>
                <p>Chat history is preserved for the last 14 days.</p>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 md:p-5 bg-white border-t border-gray-100 shadow-t-xl">
            <div class="flex gap-3 items-end">
                <textarea id="chat-input" placeholder="Type your message... (Shift + Enter for new line)" rows="1" class="flex-grow p-3 border border-gray-300 rounded-2xl resize-none focus:ring-2 focus:ring-primary focus:border-primary transition duration-200" onkeypress="handleEnter(event)"></textarea>
                <button onclick="sendMessage()" id="send-button" class="w-12 h-12 flex items-center justify-center bg-primary text-white rounded-full transition duration-300 hover:scale-105 hover:bg-green-600 shadow-lg shadow-green-500/40">
                    <i class="fas fa-paper-plane text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIGURATION ---
        const CORRECT_PASSWORD = 'STAFF';
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentStaff = null;
        let unsubscribeMessages = null;
        let isAuthReady = false;

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const loginContainer = document.getElementById('login-container');
        const passwordModal = document.getElementById('password-modal');
        const userDisplay = document.getElementById('user-display');
        const chatMessagesEl = document.getElementById('chat-messages');
        const loadingOverlay = document.getElementById('loading-overlay');
        const chatInput = document.getElementById('chat-input');
        const messageBox = document.getElementById('message-box');
        
        // Enable Firebase debugging logs for troubleshooting
        setLogLevel('debug');
        
        // --- UTILITY FUNCTIONS ---
        
        // Custom non-blocking message box (replacing alert/confirm)
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `fixed top-4 right-4 z-[10000] p-4 rounded-lg shadow-xl font-medium transition-all duration-300 transform ${isError ? 'bg-red-600' : 'bg-green-600'} translate-x-0`;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
                messageBox.classList.remove('translate-x-0');
            }, 5000);
            setTimeout(() => {
                 messageBox.style.display = 'none';
            }, 5300);
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function getProfilePath(uid) {
            return `artifacts/${appId}/users/${uid}/profile/details`;
        }
        
        function getMessagesCollectionPath() {
            return `artifacts/${appId}/public/data/messages`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
            // Format time (e.g., 03:05 PM) and date (e.g., 11/15)
            const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
            return `${time} (${dateStr})`;
        }
        
        function getFormattedDate(timestamp) {
            const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const messageDate = new Date(date);
            messageDate.setHours(0, 0, 0, 0);
            
            const diffDays = Math.round((today.getTime() - messageDate.getTime()) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }


        // --- PASSWORD VERIFICATION ---
        window.verifyPassword = function() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('password-error');
            
            if (input.value.toUpperCase() === CORRECT_PASSWORD) {
                sessionStorage.setItem('staffAuthenticated', 'true');
                passwordModal.classList.add('opacity-0');
                passwordModal.classList.add('pointer-events-none');
                setTimeout(() => { passwordModal.style.display = 'none'; }, 500);
                
                initializeAppAndAuth();
            } else {
                error.classList.remove('hidden');
                input.classList.add('border-red-500', 'animate-shake');
                input.value = '';
                
                setTimeout(() => {
                    input.classList.remove('border-red-500', 'animate-shake');
                }, 500);
                
                setTimeout(() => {
                    error.classList.add('hidden');
                }, 3000);
            }
        }

        // --- AUTHENTICATION & INITIALIZATION ---
        async function initializeAppAndAuth() {
            if (sessionStorage.getItem('staffAuthenticated') !== 'true') {
                return;
            }

            try {
                showLoading(true);
                
                // 1. Initialize App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                // 2. Sign In (using custom token if available, otherwise anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.warn("No initial auth token found, signing in anonymously.");
                    await signInAnonymously(auth);
                }

                // 3. Set up Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        console.log("Authentication successful. User UID:", user.uid);
                        checkStaffProfile(user.uid);
                    } else {
                        isAuthReady = false;
                        console.log("Authentication state changed to signed out.");
                        showChatUI(false);
                        showLoading(false);
                    }
                });
            } catch (error) {
                // *** IMPROVED ERROR LOGGING ***
                console.error("--- CRITICAL FIREBASE INIT/AUTH FAILURE ---");
                console.error("Specific Error:", error.code, error.message);
                console.error("Configuration Check (sensitive fields redacted):", 
                    { appId: appId, apiKey: firebaseConfig.apiKey ? 'PRESENT' : 'MISSING', authDomain: firebaseConfig.authDomain });
                
                showMessage(`Authentication failed (${error.code || 'UNKNOWN'}). Check console for details.`, true);
                showLoading(false);
                sessionStorage.removeItem('staffAuthenticated');
                passwordModal.style.display = 'flex';
            }
        }

        // --- PROFILE MANAGEMENT (ONE-TIME LOGIN) ---
        async function checkStaffProfile(uid) {
            const profileRef = doc(db, getProfilePath(uid));
            try {
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    currentStaff = profileSnap.data();
                    currentStaff.uid = uid;
                    await setDoc(profileRef, { lastLogin: serverTimestamp() }, { merge: true });
                    startChatSession();
                } else {
                    showLoading(false);
                    loginContainer.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching staff profile:", error);
                showMessage("Failed to load user profile.", true);
                showLoading(false);
            }
        }

        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const uid = auth.currentUser.uid;
            const name = document.getElementById('staff-name').value.trim();
            const department = document.getElementById('staff-department').value;
            const staffId = document.getElementById('staff-id').value.trim();
            
            if (!name || !department || !staffId) return;

            currentStaff = {
                uid: uid,
                name: name,
                department: department,
                staffId: staffId,
                joinedAt: Date.now(),
                lastLogin: Date.now()
            };
            
            const profileRef = doc(db, getProfilePath(uid));
            showLoading(true);

            try {
                await setDoc(profileRef, currentStaff);
                showMessage(`Welcome, ${name}! Your profile is saved.`);
                startChatSession();
            } catch (error) {
                console.error("Error creating staff profile:", error);
                showMessage("Failed to save staff details. Check your connection.", true);
                showLoading(false);
            }
        }

        // --- CHAT SESSION START ---
        function startChatSession() {
            showLoading(false);
            loginContainer.classList.add('hidden');
            showChatUI(true);
            
            const staffIdShort = currentStaff.uid.substring(0, 6);
            userDisplay.innerHTML = `${currentStaff.name} <span class="text-xs opacity-70 ml-1">#${staffIdShort}</span>`;
            
            loadMessages();
        }
        
        function showChatUI(show) {
             chatContainer.classList.toggle('hidden', !show);
             if (show) {
                 setTimeout(() => chatInput.focus(), 100);
             }
        }

        // --- CHAT MESSAGES LOGIC (2-WEEK HISTORY) ---
        function loadMessages() {
            if (!db || !currentStaff.uid) return;
            
            if (unsubscribeMessages) {
                unsubscribeMessages(); 
            }

            // Calculate timestamp for 14 days ago 
            const twoWeeksAgo = Date.now() - (14 * 24 * 60 * 60 * 1000);
            
            const messagesRef = collection(db, getMessagesCollectionPath());
            
            // Query: messages in last 14 days, ordered by timestamp
            const q = query(
                messagesRef,
                where('timestamp', '>=', twoWeeksAgo),
                orderBy('timestamp', 'asc')
            );

            // Real-time listener
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                showMessage("Real-time connection lost. Refresh the page.", true);
            });
        }

        function renderMessages(messages) {
            const shouldScroll = chatMessagesEl.scrollHeight - chatMessagesEl.scrollTop < chatMessagesEl.clientHeight + 100;
            
            chatMessagesEl.innerHTML = '';
            
            if (messages.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            } else {
                 document.getElementById('empty-state').style.display = 'none';
            }
            
            let lastDate = null;

            messages.forEach(msg => {
                // Add date divider
                const currentDateKey = getFormattedDate(msg.timestamp);
                if (currentDateKey !== lastDate) {
                    const divider = document.createElement('div');
                    divider.className = 'text-center my-6 relative';
                    divider.innerHTML = `<span class="bg-gray-50 px-3 py-1 text-xs font-medium text-gray-500 rounded-full border border-gray-200 z-10 relative">${currentDateKey}</span>`;
                    divider.style.setProperty('--primary-dark', '#E5E7EB');
                    chatMessagesEl.appendChild(divider);
                    lastDate = currentDateKey;
                }
                
                const isOwn = msg.uid === currentStaff.uid;
                const messageEl = createMessageElement(msg, isOwn);
                chatMessagesEl.appendChild(messageEl);
            });
            
            // Auto-scroll only if already near the bottom
            if (shouldScroll) {
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }
        }

        function createMessageElement(msg, isOwn) {
            const div = document.createElement('div');
            div.className = `message flex gap-3 mb-4 ${isOwn ? 'own flex-row-reverse' : 'flex-row'}`;
            
            const initial = msg.name.charAt(0).toUpperCase();
            const avatarBg = isOwn ? 'bg-primary' : 'bg-indigo-600';
            const bubbleRounded = isOwn ? 'rounded-tl-xl rounded-b-xl' : 'rounded-tr-xl rounded-b-xl';
            const nameAlignment = isOwn ? 'justify-end' : 'justify-start';

            div.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg ${avatarBg} flex-shrink-0 shadow-md">${initial}</div>
                <div class="max-w-xs md:max-w-md">
                    <div class="flex items-center gap-2 mb-1 text-xs text-gray-500 ${nameAlignment}">
                        <span class="font-semibold text-gray-800">${msg.name}</span>
                        <span class="text-primary font-medium bg-green-50 px-2 py-0.5 rounded-full text-xs">${msg.department}</span>
                        <span class="text-xs text-gray-400">${formatTimestamp(msg.timestamp)}</span>
                    </div>
                    <div class="message-bubble p-3 ${bubbleRounded} rounded-tr-xl rounded-bl-xl shadow-md">
                        ${msg.text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            return div;
        }

        window.sendMessage = async function() {
            if (!currentStaff) {
                showMessage("Please login before sending messages.", true);
                return;
            }

            const text = chatInput.value.trim();
            if (!text) return;
            
            const message = {
                uid: currentStaff.uid,
                name: currentStaff.name,
                department: currentStaff.department,
                text: text,
                timestamp: Date.now()
            };
            
            chatInput.value = '';
            chatInput.style.height = '48px'; // Reset height
            
            try {
                const messagesRef = collection(db, getMessagesCollectionPath());
                await addDoc(messagesRef, message);
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage("Failed to send message. Connection error.", true);
            }
        }

        window.handleEnter = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = '48px'; /* Min height */
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // --- LOGOUT ---
        window.logout = async function() {
            if (!window.confirm('Are you sure you want to log out?')) return; 

            showLoading(true);
            
            // Clean up listener
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            
            // Sign out
            if (auth) {
                await signOut(auth).catch(e => console.error("Sign out error:", e));
            }

            // Clean up state and UI
            currentStaff = null;
            sessionStorage.removeItem('staffAuthenticated');
            chatMessagesEl.innerHTML = '';
            
            showLoading(false);
            chatContainer.classList.add('hidden');
            loginContainer.classList.add('hidden');
            
            // Show password gate again
            passwordModal.style.display = 'flex';
            passwordModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        // --- INITIALIZE ON LOAD ---
        window.onload = () => {
             // Initial check for password gate
             if (sessionStorage.getItem('staffAuthenticated') === 'true') {
                passwordModal.style.display = 'none';
                initializeAppAndAuth();
            } else {
                passwordModal.style.display = 'flex';
                document.getElementById('password-input').focus();
            }
        };

    </script>
</body>
</html>
