<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wexford Community School • Digital Report Card System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EmailJS for sending emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* All existing CSS styles remain the same */
        :root {
            --primary: #0B8F4A; /* Wexford Green */
            --secondary: #003366; /* Dark Blue */
            --accent: #FF6B00; /* Orange */
            --light: #f8fafc;
            --gray: #e2e8f0;
            --dark: #1e293b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* ... (All existing CSS styles remain exactly the same) ... */
        
        /* Add these new styles for modal and loader */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal h3 {
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        
        .modal p {
            margin-bottom: 1.5rem;
            color: var(--dark);
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--gray);
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: left;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SCHOOL HEADER WITH LOGO -->
        <div class="school-header no-print">
            <div class="logo-container">
                <div class="school-logo">
                    <div class="logo-placeholder">
                        NEW WEXFORD<br>
                        COMMUNITY SCHOOL<br>
                        ATWIMA<br>
                        MANHYIA<br>
                        SINCE EST. 1991<br>
                        INNOVATION, TECHNOLOGY<br>
                        & DISCIPLINE
                    </div>
                </div>
                <div class="school-info">
                    <h1 class="school-name">WEXFORD COMMUNITY SCHOOL</h1>
                    <p class="school-location">Atwima Manhyia • Since 1991</p>
                    <p class="school-motto"><i class="fas fa-quote-left"></i> Innovation, Technology, and Discipline <i class="fas fa-quote-right"></i></p>
                </div>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- FORM SECTION -->
            <div class="form-section no-print">
                <h2 class="section-title"><i class="fas fa-user-edit"></i> Student Information</h2>
                
                <div class="student-selector">
                    <label for="studentSelect"><i class="fas fa-users"></i> Select Student</label>
                    <select id="studentSelect" class="student-select">
                        <option value="">-- Select a student --</option>
                        <!-- Students will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- COMMUNICATION PANEL -->
                <div class="communication-panel">
                    <h3><i class="fas fa-paper-plane"></i> Send Report to Parents</h3>
                    <div class="contact-inputs">
                        <div class="form-group">
                            <label for="parentEmail"><i class="fas fa-envelope"></i> Parent Email</label>
                            <input type="email" id="parentEmail" placeholder="parent@example.com">
                        </div>
                        <div class="form-group">
                            <label for="parentPhone"><i class="fas fa-phone"></i> Parent Phone</label>
                            <input type="tel" id="parentPhone" placeholder="+233 XX XXX XXXX">
                        </div>
                        <div class="form-group">
                            <label for="parentName"><i class="fas fa-user-friends"></i> Parent Name</label>
                            <input type="text" id="parentName" placeholder="Parent/Guardian Name">
                        </div>
                    </div>
                    <div class="communication-buttons">
                        <button class="btn com-btn btn-email" id="sendEmail">
                            <i class="fas fa-envelope"></i> Send Email with PDF
                        </button>
                        <button class="btn com-btn btn-sms" id="sendSMS">
                            <i class="fas fa-sms"></i> Send SMS
                        </button>
                        <button class="btn com-btn btn-whatsapp" id="sendWhatsApp">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button class="btn com-btn btn-save" id="saveReport">
                            <i class="fas fa-save"></i> Save Report
                        </button>
                    </div>
                </div>
                
                <form id="reportForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentName"><i class="fas fa-user"></i> Student Name</label>
                            <input type="text" id="studentName" placeholder="Enter student's full name" required>
                        </div>
                        <div class="form-group">
                            <label for="rollNumber"><i class="fas fa-hashtag"></i> Number on Roll</label>
                            <input type="text" id="rollNumber" placeholder="e.g., 1, 2, 3..." required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="className"><i class="fas fa-school"></i> Class</label>
                            <input type="text" id="className" placeholder="e.g., BS 5" value="BS 5" required>
                        </div>
                        <div class="form-group">
                            <label for="term"><i class="fas fa-calendar-alt"></i> Term</label>
                            <select id="term" required>
                                <option value="1ST TERM">1ST TERM</option>
                                <option value="2ND TERM">2ND TERM</option>
                                <option value="3RD TERM">3RD TERM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="academicYear"><i class="fas fa-calendar"></i> Academic Year</label>
                            <input type="text" id="academicYear" placeholder="e.g., 2025-2026" value="2025-2026" required>
                        </div>
                        <div class="form-group">
                            <label for="attendance"><i class="fas fa-chart-line"></i> Attendance</label>
                            <input type="text" id="attendance" placeholder="e.g., 85/90" value="85/90">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vacationDate"><i class="fas fa-plane-departure"></i> Vacation Date</label>
                            <input type="text" id="vacationDate" placeholder="e.g., 15th December, 2025" value="15th December, 2025">
                        </div>
                        <div class="form-group">
                            <label for="reopeningDate"><i class="fas fa-plane-arrival"></i> Next Term Reopens</label>
                            <input type="text" id="reopeningDate" placeholder="e.g., 10th January, 2026" value="10th January, 2026">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="conduct"><i class="fas fa-user-check"></i> Conduct</label>
                        <textarea id="conduct" placeholder="Enter student conduct remarks..." rows="3">Very well behaved and respectful. Shows good character and discipline.</textarea>
                    </div>
                    
                    <h2 class="section-title" style="margin-top: 2.5rem;"><i class="fas fa-book-open"></i> Academic Performance</h2>
                    <p style="margin-bottom: 1rem; color: #64748b;">Enter marks for Class Work (50%) and Exams (50%)</p>
                    
                    <div class="subject-header">
                        <div>SUBJECT</div>
                        <div>CLASS (50%)</div>
                        <div>EXAMS (50%)</div>
                        <div>POSITION</div>
                        <div>ACTION</div>
                    </div>
                    
                    <div id="subjectsContainer">
                        <!-- Subjects will be added here dynamically -->
                    </div>
                    
                    <div class="add-subject" id="addSubject">
                        <i class="fas fa-plus"></i> Add Another Subject
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" id="generateReport">
                            <i class="fas fa-file-alt"></i> Generate Report Card
                        </button>
                        <button type="button" class="btn btn-outline" id="resetForm">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- PREVIEW SECTION -->
            <div class="preview-section">
                <h2 class="section-title"><i class="fas fa-eye"></i> Report Card Preview</h2>
                
                <!-- Page Controls -->
                <div class="page-controls no-print">
                    <button class="page-btn active" data-page="1">Page 1</button>
                    <button class="page-btn" data-page="2">Page 2</button>
                </div>
                
                <div id="loadingPreview" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Generating report card...</p>
                </div>
                
                <div id="reportPreview" class="report-card">
                    <!-- PAGE 1 -->
                    <div id="page1" class="report-page active">
                        <!-- Watermark -->
                        <div class="watermark">
                            <div class="watermark-text">WEXFORD</div>
                        </div>
                        
                        <!-- Report Card Content -->
                        <div class="report-content">
                            <div class="report-header">
                                <h2 class="report-title">TERMINAL REPORT CARD</h2>
                                <p class="report-subtitle">WEXFORD COMMUNITY SCHOOL</p>
                                <p style="color: var(--secondary); font-weight: 500; margin-top: 0.5rem;">
                                    <i class="fas fa-quote-left"></i> Innovation, Technology, and Discipline <i class="fas fa-quote-right"></i>
                                </p>
                            </div>
                            
                            <!-- STUDENT INFORMATION -->
                            <div class="student-info-modern">
                                <div class="info-card">
                                    <div class="info-label">Student Name</div>
                                    <div class="info-value" id="previewName">WESLER NYAMEKYE ASANTE</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Class</div>
                                    <div class="info-value" id="previewClass">BS 5</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Term</div>
                                    <div class="info-value" id="previewTerm">1ST TERM</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Academic Year</div>
                                    <div class="info-value" id="previewYear">2025-2026</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Number on Roll</div>
                                    <div class="info-value" id="previewRoll">1</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Attendance</div>
                                    <div class="info-value" id="previewAttendance">85/90</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Vacation Date</div>
                                    <div class="info-value" id="previewVacation">15th December, 2025</div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-label">Next Term Reopens</div>
                                    <div class="info-value" id="previewReopening">10th January, 2026</div>
                                </div>
                            </div>
                            
                            <!-- CONDUCT -->
                            <div style="margin-bottom: 2rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--accent);">
                                <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">Conduct:</div>
                                <div id="previewConduct">Very well behaved and respectful. Shows good character and discipline.</div>
                            </div>
                            
                            <h3 style="margin-bottom: 1rem; color: var(--secondary);">ACADEMIC PERFORMANCE</h3>
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>SUBJECT</th>
                                        <th>CLASS (50%)</th>
                                        <th>EXAMS (50%)</th>
                                        <th>TOTAL</th>
                                        <th>GRADE</th>
                                        <th>POSITION</th>
                                        <th>REMARK</th>
                                    </tr>
                                </thead>
                                <tbody id="marksTableBody1">
                                    <!-- Marks for Page 1 will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- PAGE 2 -->
                    <div id="page2" class="report-page">
                        <!-- Watermark -->
                        <div class="watermark">
                            <div class="watermark-text">WEXFORD</div>
                        </div>
                        
                        <div class="report-content page2-content">
                            <!-- More subjects (if any) -->
                            <h3 style="margin-bottom: 1rem; color: var(--secondary);">ACADEMIC PERFORMANCE (CONTINUED)</h3>
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>SUBJECT</th>
                                        <th>CLASS (50%)</th>
                                        <th>EXAMS (50%)</th>
                                        <th>TOTAL</th>
                                        <th>GRADE</th>
                                        <th>POSITION</th>
                                        <th>REMARK</th>
                                    </tr>
                                </thead>
                                <tbody id="marksTableBody2">
                                    <!-- Marks for Page 2 will be populated here -->
                                </tbody>
                            </table>
                            
                            <div class="remarks-section">
                                <div class="remark-box">
                                    <h4 class="remark-title">Teacher's Remark</h4>
                                    <div class="remark-content" id="teacherRemark">
                                        <!-- Teacher's remark will be added here -->
                                    </div>
                                </div>
                                <div class="remark-box">
                                    <h4 class="remark-title">Headteacher's Remark</h4>
                                    <div class="remark-content" id="headteacherRemark">
                                        <!-- Headteacher's remark will be added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grading-system">
                                <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">GRADING SYSTEM</h4>
                                <table class="grading-table">
                                    <thead>
                                        <tr>
                                            <th>MARKS RANGE</th>
                                            <th>GRADE</th>
                                            <th>REMARK</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>80 - 100</td>
                                            <td class="grade-A">A</td>
                                            <td>Excellent</td>
                                        </tr>
                                        <tr>
                                            <td>70 - 79</td>
                                            <td class="grade-B">B</td>
                                            <td>Very Good</td>
                                        </tr>
                                        <tr>
                                            <td>60 - 69</td>
                                            <td class="grade-C">C</td>
                                            <td>Good</td>
                                        </tr>
                                        <tr>
                                            <td>50 - 59</td>
                                            <td class="grade-D">D</td>
                                            <td>Credit</td>
                                        </tr>
                                        <tr>
                                            <td>40 - 49</td>
                                            <td class="grade-E">E</td>
                                            <td>Pass</td>
                                        </tr>
                                        <tr>
                                            <td>Below 40</td>
                                            <td class="grade-F">F</td>
                                            <td>Fail</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="signature-section">
                                <div class="signature-box">
                                    <p><strong>Class Teacher's Signature</strong></p>
                                    <div class="signature-line"></div>
                                    <p style="margin-top: 0.5rem;">__________________________</p>
                                </div>
                                <div class="signature-box">
                                    <p><strong>Headteacher's Signature</strong></p>
                                    <div class="signature-line"></div>
                                    <p style="margin-top: 0.5rem;">__________________________</p>
                                </div>
                                <div class="signature-box">
                                    <p><strong>School Stamp</strong></p>
                                    <div style="margin-top: 3rem; font-style: italic;">Date: _________________</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-box no-print" id="summaryBox" style="display: none;">
                    <!-- Summary will be added here -->
                </div>
                
                <div class="action-buttons no-print" style="margin-top: 2rem;">
                    <button class="btn btn-secondary" id="printReport">
                        <i class="fas fa-print"></i> Print Report Card
                    </button>
                    <button class="btn btn-download" id="downloadPDF">
                        <i class="fas fa-download"></i> Download as PDF
                    </button>
                    <button class="btn btn-accent" id="sendAll">
                        <i class="fas fa-paper-plane"></i> Send to All
                    </button>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <footer class="no-print">
            <div class="footer-links">
                <a href="#"><i class="fas fa-info-circle"></i> About</a>
                <a href="#"><i class="fas fa-shield-alt"></i> Privacy</a>
                <a href="#"><i class="fas fa-phone-alt"></i> Contact</a>
            </div>
            <p>© 2025 Wexford Community School • All Rights Reserved</p>
        </footer>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="notification">
        <div id="notificationMessage"></div>
    </div>

    <!-- EMAIL MODAL -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-envelope"></i> Sending Report Card</h3>
            <div class="progress-bar">
                <div class="progress" id="emailProgress"></div>
            </div>
            <div id="emailStatus" class="status-message status-info">
                <i class="fas fa-spinner fa-spin"></i> Generating PDF...
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" id="cancelSend">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS (You need to get your own Public Key from EmailJS)
        // Go to https://www.emailjs.com/ and create a free account
        // Replace 'YOUR_PUBLIC_KEY' with your actual EmailJS public key
        // Replace 'YOUR_SERVICE_ID' with your EmailJS service ID
        // Replace 'YOUR_TEMPLATE_ID' with your EmailJS template ID
        emailjs.init('YOUR_PUBLIC_KEY'); // ← Replace with your actual EmailJS public key

        // DOM Elements
        const reportForm = document.getElementById('reportForm');
        const subjectsContainer = document.getElementById('subjectsContainer');
        const addSubjectBtn = document.getElementById('addSubject');
        const generateReportBtn = document.getElementById('generateReport');
        const resetFormBtn = document.getElementById('resetForm');
        const printReportBtn = document.getElementById('printReport');
        const downloadPDFBtn = document.getElementById('downloadPDF');
        const loadingPreview = document.getElementById('loadingPreview');
        const reportPreview = document.getElementById('reportPreview');
        const studentSelect = document.getElementById('studentSelect');
        const summaryBox = document.getElementById('summaryBox');
        const pageButtons = document.querySelectorAll('.page-btn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const emailModal = document.getElementById('emailModal');
        const emailProgress = document.getElementById('emailProgress');
        const emailStatus = document.getElementById('emailStatus');
        const cancelSendBtn = document.getElementById('cancelSend');
        
        // Communication buttons
        const sendEmailBtn = document.getElementById('sendEmail');
        const sendSMSBtn = document.getElementById('sendSMS');
        const sendWhatsAppBtn = document.getElementById('sendWhatsApp');
        const saveReportBtn = document.getElementById('saveReport');
        const sendAllBtn = document.getElementById('sendAll');
        
        // Variables for tracking email sending
        let emailSendingInProgress = false;
        let currentPDFBlob = null;
        
        // Student data from the document (30+ students)
        const students = [
            { name: "WESLER NYAMEKYE ASANTE", class: "BS 5", term: "1ST TERM", subjects: ["MATHEMATICS", "ENGLISH LANGUAGE", "INTEGRATED SCIENCE", "HISTORY", "COMPUTING", "CREATIVE ART", "RME", "GHANAIAN LANGUAGE"] },
            { name: "LEMUEL DAPAA AGYABENG", class: "BS 5", term: "1ST TERM", subjects: ["MATHEMATICS", "ENGLISH LANGUAGE", "INTEGRATED SCIENCE", "SOCIAL STUDIES", "CAREER TECHNOLOGY", "CREATIVE ART", "RME", "GHANAIAN LANGUAGE"] },
            // ... (all other student data remains the same)
        ];
        
        // Grading system
        const gradingSystem = [
            { min: 80, max: 100, grade: 'A', remark: 'Excellent' },
            { min: 70, max: 79, grade: 'B', remark: 'Very Good' },
            { min: 60, max: 69, grade: 'C', remark: 'Good' },
            { min: 50, max: 59, grade: 'D', remark: 'Credit' },
            { min: 40, max: 49, grade: 'E', remark: 'Pass' },
            { min: 0, max: 39, grade: 'F', remark: 'Fail' }
        ];
        
        // Show notification
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Update email modal status
        function updateEmailStatus(message, type = 'info', progress = 0) {
            emailStatus.innerHTML = message;
            emailStatus.className = `status-message status-${type}`;
            emailProgress.style.width = `${progress}%`;
        }
        
        // Generate PDF as blob (for email attachment)
        async function generatePDFBlob() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Capture Page 1
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Generating PDF page 1...', 'info', 30);
                const page1 = document.getElementById('page1');
                const canvas1 = await html2canvas(page1, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight1 = (canvas1.height * imgWidth) / canvas1.width;
                
                // Add Page 1 to PDF
                pdf.addImage(canvas1.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight1);
                
                // Add new page
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Generating PDF page 2...', 'info', 60);
                pdf.addPage();
                
                // Capture Page 2
                const page2 = document.getElementById('page2');
                const canvas2 = await html2canvas(page2, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
                
                // Add Page 2 to PDF
                pdf.addImage(canvas2.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight2);
                
                // Generate blob
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Finalizing PDF...', 'info', 90);
                const pdfBlob = pdf.output('blob');
                
                return pdfBlob;
            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }
        
        // Convert blob to base64 for EmailJS attachment
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Remove the data URL prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Send PDF via EmailJS
        async function sendPDFViaEmail() {
            try {
                const studentName = document.getElementById('studentName').value;
                const parentEmail = document.getElementById('parentEmail').value;
                const parentName = document.getElementById('parentName').value;
                const className = document.getElementById('className').value;
                const term = document.getElementById('term').value;
                const academicYear = document.getElementById('academicYear').value;
                
                if (!parentEmail) {
                    throw new Error('Please enter parent email address');
                }
                
                if (!studentName) {
                    throw new Error('Please generate a report first');
                }
                
                // Generate PDF
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Generating PDF...', 'info', 20);
                const pdfBlob = await generatePDFBlob();
                
                // Convert blob to base64
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Preparing email attachment...', 'info', 60);
                const pdfBase64 = await blobToBase64(pdfBlob);
                
                // Prepare email template parameters
                const templateParams = {
                    to_email: parentEmail,
                    to_name: parentName || 'Parent/Guardian',
                    student_name: studentName,
                    class_name: className,
                    term: term,
                    academic_year: academicYear,
                    school_name: 'Wexford Community School',
                    attachment: pdfBase64,
                    attachment_name: `Wexford_${studentName.replace(/\s+/g, '_')}_${className}_${term}.pdf`
                };
                
                // Send email using EmailJS
                updateEmailStatus('<i class="fas fa-spinner fa-spin"></i> Sending email...', 'info', 80);
                
                // Send email with attachment
                // Note: You need to set up an EmailJS template that accepts attachments
                const response = await emailjs.send(
                    'YOUR_SERVICE_ID', // Replace with your EmailJS service ID
                    'YOUR_TEMPLATE_ID', // Replace with your EmailJS template ID
                    templateParams
                );
                
                updateEmailStatus('<i class="fas fa-check-circle"></i> Email sent successfully!', 'success', 100);
                return response;
                
            } catch (error) {
                console.error('Email sending error:', error);
                updateEmailStatus(`<i class="fas fa-exclamation-circle"></i> Error: ${error.message || 'Failed to send email'}`, 'error', 0);
                throw error;
            }
        }
        
        // Send PDF via SMS (using Twilio API - requires backend)
        async function sendPDFViaSMS() {
            const studentName = document.getElementById('studentName').value;
            const parentPhone = document.getElementById('parentPhone').value;
            
            if (!studentName) {
                showNotification('Please generate a report first', 'error');
                return;
            }
            
            if (!parentPhone) {
                showNotification('Please enter parent phone number', 'error');
                return;
            }
            
            // Generate PDF first
            const pdfBlob = await generatePDFBlob();
            currentPDFBlob = pdfBlob;
            
            // Note: SMS with PDF attachment requires Twilio API or similar service
            // For demo purposes, we'll create a download link and send it via SMS
            const className = document.getElementById('className').value;
            const term = document.getElementById('term').value;
            
            // Create download link
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const downloadLink = `${window.location.origin}/download/report.pdf`;
            
            // Create SMS content with download link
            const message = `Wexford School: ${term} report for ${studentName} (${className}) is ready. Download: ${downloadLink}`;
            
            // For actual implementation, you would call your backend API
            // Example: await fetch('/api/send-sms', { method: 'POST', body: JSON.stringify({ phone: parentPhone, message: message }) });
            
            // For demo, open SMS app
            const smsLink = `sms:${parentPhone}?body=${encodeURIComponent(message)}`;
            window.open(smsLink, '_blank');
            
            showNotification('SMS app opened with download link', 'success');
        }
        
        // Send PDF via WhatsApp
        async function sendPDFViaWhatsApp() {
            const studentName = document.getElementById('studentName').value;
            const parentPhone = document.getElementById('parentPhone').value;
            
            if (!studentName) {
                showNotification('Please generate a report first', 'error');
                return;
            }
            
            if (!parentPhone) {
                showNotification('Please enter parent phone number', 'error');
                return;
            }
            
            // Generate PDF
            const pdfBlob = await generatePDFBlob();
            currentPDFBlob = pdfBlob;
            
            // Create download link
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Create WhatsApp message
            const className = document.getElementById('className').value;
            const term = document.getElementById('term').value;
            
            const message = `Dear Parent,\n\n${term} report card for *${studentName}* (${className}) is now available.\n\nDownload link: ${pdfUrl}\n\n*Wexford Community School*\n*Innovation, Technology, and Discipline*`;
            
            // Create WhatsApp link
            const whatsappLink = `https://wa.me/${parentPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            
            // Open WhatsApp
            window.open(whatsappLink, '_blank');
            
            showNotification('Opening WhatsApp with download link', 'success');
        }
        
        // Send Email button
        sendEmailBtn.addEventListener('click', async function() {
            emailSendingInProgress = true;
            emailModal.style.display = 'flex';
            
            try {
                await sendPDFViaEmail();
                
                // Close modal after 2 seconds on success
                setTimeout(() => {
                    if (emailSendingInProgress) {
                        emailModal.style.display = 'none';
                        emailSendingInProgress = false;
                        showNotification('Report card sent via email successfully!', 'success');
                    }
                }, 2000);
                
            } catch (error) {
                // Keep modal open to show error
                setTimeout(() => {
                    if (emailSendingInProgress) {
                        showNotification(`Email sending failed: ${error.message}`, 'error');
                    }
                }, 1000);
            }
        });
        
        // Cancel send button
        cancelSendBtn.addEventListener('click', function() {
            emailSendingInProgress = false;
            emailModal.style.display = 'none';
            showNotification('Email sending cancelled', 'warning');
        });
        
        // Send SMS button (updated)
        sendSMSBtn.addEventListener('click', async function() {
            try {
                await sendPDFViaSMS();
            } catch (error) {
                showNotification(`SMS sending failed: ${error.message}`, 'error');
            }
        });
        
        // Send WhatsApp button (updated)
        sendWhatsAppBtn.addEventListener('click', async function() {
            try {
                await sendPDFViaWhatsApp();
            } catch (error) {
                showNotification(`WhatsApp sending failed: ${error.message}`, 'error');
            }
        });
        
        // Send to all channels
        sendAllBtn.addEventListener('click', async function() {
            const studentName = document.getElementById('studentName').value;
            const parentEmail = document.getElementById('parentEmail').value;
            const parentPhone = document.getElementById('parentPhone').value;
            
            if (!studentName) {
                showNotification('Please generate a report first', 'error');
                return;
            }
            
            if (!parentEmail && !parentPhone) {
                showNotification('Please enter at least one contact method', 'error');
                return;
            }
            
            // Generate PDF first (will be used for all channels)
            try {
                const pdfBlob = await generatePDFBlob();
                currentPDFBlob = pdfBlob;
                
                // Save report
                saveReportBtn.click();
                
                // Send to all available channels
                if (parentEmail) {
                    setTimeout(() => sendEmailBtn.click(), 100);
                }
                
                if (parentPhone) {
                    setTimeout(() => {
                        sendSMSBtn.click();
                        setTimeout(() => sendWhatsAppBtn.click(), 500);
                    }, 300);
                }
                
                showNotification('Report being sent through all available channels', 'success');
                
            } catch (error) {
                showNotification(`Failed to generate PDF: ${error.message}`, 'error');
            }
        });
        
        // Page navigation
        pageButtons.forEach(button => {
            button.addEventListener('click', function() {
                const pageNum = this.getAttribute('data-page');
                
                // Update active button
                pageButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show selected page
                document.querySelectorAll('.report-page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(`page${pageNum}`).classList.add('active');
            });
        });
        
        // Initialize student dropdown
        function initializeStudentDropdown() {
            studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
            
            students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${student.name} (${student.class})`;
                studentSelect.appendChild(option);
            });
        }
        
        // Load student data when selected
        studentSelect.addEventListener('change', function() {
            const selectedIndex = this.value;
            
            if (selectedIndex !== "") {
                const student = students[selectedIndex];
                
                // Fill form with student data
                document.getElementById('studentName').value = student.name;
                document.getElementById('className').value = student.class;
                document.getElementById('term').value = student.term;
                document.getElementById('rollNumber').value = parseInt(selectedIndex) + 1;
                
                // Clear existing subjects
                subjectsContainer.innerHTML = '';
                
                // Add subjects for this student
                student.subjects.forEach(subject => {
                    addSubjectRow(subject);
                });
                
                // Generate report automatically
                setTimeout(generateReport, 500);
            }
        });
        
        // Add subject row
        function addSubjectRow(subjectName = "") {
            const subjectRow = document.createElement('div');
            subjectRow.className = 'subject-row fade-in';
            subjectRow.innerHTML = `
                <div data-label="Subject:">
                    <input type="text" class="subjectInput" placeholder="Subject name" value="${subjectName}" required>
                </div>
                <div data-label="Class (50%):">
                    <input type="number" class="classMarks" placeholder="Marks" min="0" max="50" value="${Math.floor(Math.random() * 26) + 25}" required>
                </div>
                <div data-label="Exams (50%):">
                    <input type="number" class="examMarks" placeholder="Marks" min="0" max="50" value="${Math.floor(Math.random() * 26) + 25}" required>
                </div>
                <div data-label="Position:">
                    <input type="number" class="position" placeholder="Position" min="1" value="${Math.floor(Math.random() * 20) + 1}">
                </div>
                <div>
                    <button type="button" class="remove-subject">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            subjectsContainer.appendChild(subjectRow);
            
            // Add event listener to the remove button
            const removeBtn = subjectRow.querySelector('.remove-subject');
            removeBtn.addEventListener('click', function() {
                subjectRow.remove();
                setTimeout(generateReport, 100);
            });
            
            // Add input event listeners
            const subjectInput = subjectRow.querySelector('.subjectInput');
            const classMarks = subjectRow.querySelector('.classMarks');
            const examMarks = subjectRow.querySelector('.examMarks');
            const position = subjectRow.querySelector('.position');
            
            subjectInput.addEventListener('input', generateReport);
            classMarks.addEventListener('input', generateReport);
            examMarks.addEventListener('input', generateReport);
            position.addEventListener('input', generateReport);
        }
        
        // Add subject button event
        addSubjectBtn.addEventListener('click', function() {
            addSubjectRow();
        });
        
        // Generate report card
        generateReportBtn.addEventListener('click', generateReport);
        
        // Reset form
        resetFormBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                reportForm.reset();
                subjectsContainer.innerHTML = '';
                
                // Add default subjects
                const defaultSubjects = ["MATHEMATICS", "ENGLISH LANGUAGE", "INTEGRATED SCIENCE", "HISTORY", "COMPUTING", "CREATIVE ART", "RME", "GHANAIAN LANGUAGE"];
                defaultSubjects.forEach(subject => {
                    addSubjectRow(subject);
                });
                
                // Reset student select
                studentSelect.value = "";
                
                // Reset contact info
                document.getElementById('parentEmail').value = "";
                document.getElementById('parentPhone').value = "";
                document.getElementById('parentName').value = "";
                
                // Generate default report
                setTimeout(generateReport, 100);
            }
        });
        
        // Print report card
        printReportBtn.addEventListener('click', function() {
            window.print();
        });
        
        // Download as PDF
        downloadPDFBtn.addEventListener('click', async function() {
            const button = this;
            const originalHTML = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            button.disabled = true;
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Capture Page 1
                const page1 = document.getElementById('page1');
                const canvas1 = await html2canvas(page1, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight1 = (canvas1.height * imgWidth) / canvas1.width;
                
                // Add Page 1 to PDF
                pdf.addImage(canvas1.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight1);
                
                // Add new page
                pdf.addPage();
                
                // Capture Page 2
                const page2 = document.getElementById('page2');
                const canvas2 = await html2canvas(page2, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
                
                // Add Page 2 to PDF
                pdf.addImage(canvas2.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight2);
                
                // Save PDF
                const studentName = document.getElementById('studentName').value || 'ReportCard';
                const className = document.getElementById('className').value || 'Class';
                const term = document.getElementById('term').value || 'Term';
                
                pdf.save(`Wexford_${studentName.replace(/\s+/g, '_')}_${className}_${term}.pdf`);
                
                showNotification('Report card downloaded successfully as PDF!', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            } finally {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        });
        
        // Save report function
        saveReportBtn.addEventListener('click', function() {
            const studentName = document.getElementById('studentName').value;
            
            if (!studentName) {
                showNotification('Please enter student name first', 'error');
                return;
            }
            
            // Get all form data
            const reportData = {
                studentName: studentName,
                rollNumber: document.getElementById('rollNumber').value,
                className: document.getElementById('className').value,
                term: document.getElementById('term').value,
                academicYear: document.getElementById('academicYear').value,
                attendance: document.getElementById('attendance').value,
                vacationDate: document.getElementById('vacationDate').value,
                reopeningDate: document.getElementById('reopeningDate').value,
                conduct: document.getElementById('conduct').value,
                parentEmail: document.getElementById('parentEmail').value,
                parentPhone: document.getElementById('parentPhone').value,
                parentName: document.getElementById('parentName').value,
                subjects: [],
                timestamp: new Date().toISOString()
            };
            
            // Get subjects data
            const subjectInputs = document.querySelectorAll('.subjectInput');
            const classMarksInputs = document.querySelectorAll('.classMarks');
            const examMarksInputs = document.querySelectorAll('.examMarks');
            const positionInputs = document.querySelectorAll('.position');
            
            for (let i = 0; i < subjectInputs.length; i++) {
                const subject = subjectInputs[i].value.trim();
                const classMarks = parseInt(classMarksInputs[i].value) || 0;
                const examMarks = parseInt(examMarksInputs[i].value) || 0;
                const position = positionInputs[i].value || "";
                
                if (subject) {
                    const total = classMarks + examMarks;
                    const grade = calculateGrade(total);
                    
                    reportData.subjects.push({
                        name: subject,
                        classMarks: classMarks,
                        examMarks: examMarks,
                        total: total,
                        grade: grade.grade,
                        position: position
                    });
                }
            }
            
            // Save to localStorage
            const reports = JSON.parse(localStorage.getItem('wexfordReports') || '[]');
            reports.push(reportData);
            localStorage.setItem('wexfordReports', JSON.stringify(reports));
            
            showNotification(`Report saved successfully for ${studentName}!`, 'success');
        });
        
        // Generate report function
        function generateReport() {
            // Show loading
            loadingPreview.style.display = 'flex';
            reportPreview.style.opacity = '0.5';
            summaryBox.style.display = 'none';
            
            // Simulate processing delay
            setTimeout(() => {
                // Get form values
                const studentName = document.getElementById('studentName').value || "WESLER NYAMEKYE ASANTE";
                const rollNumber = document.getElementById('rollNumber').value || "1";
                const className = document.getElementById('className').value || "BS 5";
                const term = document.getElementById('term').value || "1ST TERM";
                const academicYear = document.getElementById('academicYear').value || "2025-2026";
                const vacationDate = document.getElementById('vacationDate').value || "15th December, 2025";
                const reopeningDate = document.getElementById('reopeningDate').value || "10th January, 2026";
                const attendance = document.getElementById('attendance').value || "85/90";
                const conduct = document.getElementById('conduct').value || "Very well behaved and respectful. Shows good character and discipline.";
                
                // Get subjects and marks
                const subjectInputs = document.querySelectorAll('.subjectInput');
                const classMarksInputs = document.querySelectorAll('.classMarks');
                const examMarksInputs = document.querySelectorAll('.examMarks');
                const positionInputs = document.querySelectorAll('.position');
                
                let subjects = [];
                let totalClassMarks = 0;
                let totalExamMarks = 0;
                let totalMarks = 0;
                let subjectCount = 0;
                let totalGradePoints = 0;
                
                for (let i = 0; i < subjectInputs.length; i++) {
                    const subject = subjectInputs[i].value.trim();
                    const classMarks = parseInt(classMarksInputs[i].value) || 0;
                    const examMarks = parseInt(examMarksInputs[i].value) || 0;
                    const position = positionInputs[i].value || "";
                    
                    if (subject && !isNaN(classMarks) && !isNaN(examMarks)) {
                        const total = classMarks + examMarks;
                        const grade = calculateGrade(total);
                        const remark = getSubjectRemark(total);
                        
                        subjects.push({
                            name: subject,
                            classMarks: classMarks,
                            examMarks: examMarks,
                            total: total,
                            grade: grade.grade,
                            gradeClass: `grade-${grade.grade}`,
                            position: position,
                            remark: remark
                        });
                        
                        totalClassMarks += classMarks;
                        totalExamMarks += examMarks;
                        totalMarks += total;
                        subjectCount++;
                        
                        // Calculate grade points (A=5, B=4, C=3, D=2, E=1, F=0)
                        const gradePoints = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
                        totalGradePoints += gradePoints[grade.grade] || 0;
                    }
                }
                
                // Calculate averages
                const averageClassMarks = subjectCount > 0 ? Math.round(totalClassMarks / subjectCount) : 0;
                const averageExamMarks = subjectCount > 0 ? Math.round(totalExamMarks / subjectCount) : 0;
                const averageTotal = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
                const averageGrade = calculateGrade(averageTotal);
                const averageGradePoints = subjectCount > 0 ? (totalGradePoints / subjectCount).toFixed(2) : 0;
                
                // Determine overall performance
                let performanceIndex;
                if (averageTotal >= 80) performanceIndex = 0;
                else if (averageTotal >= 70) performanceIndex = 1;
                else if (averageTotal >= 60) performanceIndex = 2;
                else if (averageTotal >= 50) performanceIndex = 3;
                else performanceIndex = 4;
                
                // Update preview
                document.getElementById('previewName').textContent = studentName;
                document.getElementById('previewClass').textContent = className;
                document.getElementById('previewTerm').textContent = term;
                document.getElementById('previewYear').textContent = academicYear;
                document.getElementById('previewRoll').textContent = rollNumber;
                document.getElementById('previewVacation').textContent = vacationDate;
                document.getElementById('previewReopening').textContent = reopeningDate;
                document.getElementById('previewAttendance').textContent = attendance;
                document.getElementById('previewConduct').textContent = conduct;
                
                // Split subjects for two pages
                const midPoint = Math.ceil(subjects.length / 2);
                const page1Subjects = subjects.slice(0, midPoint);
                const page2Subjects = subjects.slice(midPoint);
                
                // Update marks table for Page 1
                const marksTableBody1 = document.getElementById('marksTableBody1');
                marksTableBody1.innerHTML = '';
                
                page1Subjects.forEach(subject => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in';
                    row.innerHTML = `
                        <td>${subject.name}</td>
                        <td>${subject.classMarks}</td>
                        <td>${subject.examMarks}</td>
                        <td>${subject.total}</td>
                        <td class="${subject.gradeClass}">${subject.grade}</td>
                        <td>${subject.position}</td>
                        <td>${subject.remark}</td>
                    `;
                    marksTableBody1.appendChild(row);
                });
                
                // Update marks table for Page 2
                const marksTableBody2 = document.getElementById('marksTableBody2');
                marksTableBody2.innerHTML = '';
                
                page2Subjects.forEach(subject => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in';
                    row.innerHTML = `
                        <td>${subject.name}</td>
                        <td>${subject.classMarks}</td>
                        <td>${subject.examMarks}</td>
                        <td>${subject.total}</td>
                        <td class="${subject.gradeClass}">${subject.grade}</td>
                        <td>${subject.position}</td>
                        <td>${subject.remark}</td>
                    `;
                    marksTableBody2.appendChild(row);
                });
                
                // Update remarks
                document.getElementById('teacherRemark').textContent = teacherRemarks[performanceIndex];
                document.getElementById('headteacherRemark').textContent = headteacherRemarks[performanceIndex];
                
                // Update summary box
                summaryBox.style.display = 'grid';
                summaryBox.innerHTML = `
                    <div class="summary-item">
                        <h3>${averageTotal}%</h3>
                        <p>Average Score</p>
                    </div>
                    <div class="summary-item">
                        <h3 class="${averageGrade.gradeClass}">${averageGrade.grade}</h3>
                        <p>Overall Grade</p>
                    </div>
                    <div class="summary-item">
                        <h3>${averageGradePoints}</h3>
                        <p>Grade Point Average</p>
                    </div>
                `;
                
                // Hide loading and show preview
                loadingPreview.style.display = 'none';
                reportPreview.style.opacity = '1';
                
                // Add fade-in animation to new content
                document.querySelectorAll('.fade-in').forEach(el => {
                    el.style.animation = 'fadeIn 0.5s ease forwards';
                });
                
            }, 800);
        }
        
        // Calculate grade based on total marks
        function calculateGrade(total) {
            for (const grade of gradingSystem) {
                if (total >= grade.min && total <= grade.max) {
                    return grade;
                }
            }
            return gradingSystem[gradingSystem.length - 1];
        }
        
        // Get subject remark based on marks
        function getSubjectRemark(total) {
            if (total >= 80) return "Excellent";
            if (total >= 70) return "Very Good";
            if (total >= 60) return "Good";
            if (total >= 50) return "Credit";
            if (total >= 40) return "Pass";
            return "Needs Improvement";
        }
        
        // Initialize the form with default data
        function initializeForm() {
            // Add default subjects
            const defaultSubjects = ["MATHEMATICS", "ENGLISH LANGUAGE", "INTEGRATED SCIENCE", "HISTORY", "COMPUTING", "CREATIVE ART", "RME", "GHANAIAN LANGUAGE"];
            defaultSubjects.forEach(subject => {
                addSubjectRow(subject);
            });
            
            // Populate student dropdown
            initializeStudentDropdown();
            
            // Generate initial report
            generateReport();
        }
        
        // Add input event listeners to form fields
        document.querySelectorAll('#reportForm input, #reportForm select, #reportForm textarea').forEach(input => {
            input.addEventListener('input', generateReport);
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeForm);
        
        // Teacher remarks based on performance
        const teacherRemarks = [
            "An exceptional student with outstanding performance. Shows great initiative and consistently exceeds expectations. Demonstrates excellent understanding of all subjects.",
            "A very good student who performs well in all subjects. Shows good understanding of concepts and applies knowledge effectively. Consistent effort is evident.",
            "Good performance with room for improvement. Shows understanding of most concepts but needs to work on challenging areas. With more focus, better results can be achieved.",
            "Satisfactory performance. Basic understanding of concepts but needs to put in more effort to improve grades. Regular practice and study will help.",
            "Needs to improve performance. Struggles with several concepts and should seek extra help in weak subjects. More dedication to studies is required."
        ];
        
        // Headteacher remarks
        const headteacherRemarks = [
            "Excellent academic performance. Keep up the good work and continue to be a role model to other students.",
            "Very good results. Continue to work hard and aim for even higher achievement next term.",
            "Good effort shown this term. With more focus and dedication, you can achieve better results.",
            "Satisfactory performance. More effort and commitment to studies is required for improvement.",
            "Needs significant improvement. Must take studies more seriously and seek help where needed."
        ];
    </script>
</body>
</html>
